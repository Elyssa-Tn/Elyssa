import { useEffect, useState } from "react";
import * as L from "leaflet";
import { CssBaseline, CssVarsProvider, Divider, Sheet } from "@mui/joy";
import { useDispatch, useSelector } from "react-redux";
import { initializeElections } from "./reducers/electionReducer";

import {
  experimental_extendTheme as materialExtendTheme,
  Experimental_CssVarsProvider as MaterialCssVarsProvider,
  THEME_ID as MATERIAL_THEME_ID,
} from "@mui/material/styles";

import Layout from "./Layout";
import ModalContents from "./ModalContents/ModalContents";
import MapCard from "./MapCard/MapCard2";
import Navbar from "./Navbar";
import MapTitle from "./MapTitle";
import theme from "./theme";
import { getGeoJSON } from "./services/geojson";
import { setMaps } from "./reducers/mapReducer";
import { setClassNumber, setMinMax } from "./reducers/interfaceReducer";

import delegation from "./assets/delegation.json";
import gouvernorat from "./assets/gouvernorat.json";

function App() {
  const materialTheme = materialExtendTheme();

  const dispatch = useDispatch();

  const init = useSelector((state) => state.elections.init);

  const levels = useSelector((state) => state.interface.levels);

  const compare = useSelector((state) => state.interface.compareToggle);
  const [bounds, setBounds] = useState(null);

  // const maps = useSelector((state) => state.maps.maps);
  const map = {
    1: {
      election: {
        pays: "Tunisie",
        type_election: "TNMUN",
        mode_scrutin: "Proportionnel",
        nombre_tours: 1,
        uninominal_liste: "Scrutin de listes",
        age_minimum_electeur: 18,
        age_maximum_electeur: null,
        territorial_national: false,
        partiel_general: "Générale",
        age_minimum_candidat: 23,
        age_maximum_candidat: null,
        militaires: null,
        juges: null,
        autres_exclus: null,
        parite: null,
        jeunesse: null,
        debut: "2018-05-06",
        fin: "2018-05-06",
        date_campagne: "2018-04-14",
        date_decret_officiel: "2018-05-04",
        date_loi_electorale: "2014-05-26",
        date_constitution: "2014-02-10",
        date_planifiee: "2017-12-17",
        description: "",
        silence: "2018-05-05",
        code_election: "tnmun2018",
        nom: "Elections municipales 2018",
        nombre_sieges: null,
        rcno: 8,
        decoupage_minimum: "commune",
        decoupage_maximum: "delegation",
        decoupages_consultables: null,
        version_administratif: null,
      },
      parti: {
        code_parti: "NIDA",
        denomination: null,
        type: null,
        groupement: null,
        an_creation: null,
        pays: "Tunisie",
        rcno: 20,
        description: null,
        sigle: null,
        logo: null,
        classement_politique: null,
        denomination_ar: "حركة نداء تونس",
        denomination_fr: "Nidaa Tounes",
      },
      resultats: {
        gouvernorat: {
          data: {
            type: "data",
            code_election: "tnmun2018",
            decoupage: "gouvernorat",
            variables: [
              {
                code_variable: "prc",
                code_parti: "NIDA",
                resultat: {
                  11: 26.17,
                  12: 20.9,
                  13: 20.41,
                  14: 22.48,
                  15: 22.18,
                  16: 19.48,
                  17: 20,
                  21: 24.05,
                  22: 30.95,
                  23: 30.5,
                  24: 18.16,
                  31: 21.21,
                  32: 22.21,
                  33: 24.18,
                  34: 19.28,
                  41: 21.46,
                  42: 23.69,
                  43: 20.52,
                  51: 13.76,
                  52: 12.08,
                  53: 11.53,
                  61: 16.94,
                  62: 12.08,
                  63: 10.9,
                  Total: 21,
                },
              },
              {
                code_variable: "voix",
                code_parti: "NIDA",
                resultat: {
                  11: 37460,
                  12: 16357,
                  13: 19752,
                  14: 11256,
                  15: 34197,
                  16: 6986,
                  17: 15061,
                  21: 10579,
                  22: 15308,
                  23: 12553,
                  24: 6897,
                  31: 24238,
                  32: 26934,
                  33: 17538,
                  34: 31872,
                  41: 17721,
                  42: 19891,
                  43: 14955,
                  51: 8222,
                  52: 9269,
                  53: 1909,
                  61: 10687,
                  62: 2853,
                  63: 3391,
                  Total: 375886,
                },
              },
            ],
          },
        },
        delegation: {
          data: {
            type: "data",
            code_election: "tnmun2018",
            decoupage: "delegation",
            variables: [
              {
                code_variable: "prc",
                code_parti: "NIDA",
                resultat: {
                  1151: 31.68,
                  1152: 24.51,
                  1153: 31.79,
                  1154: 23.94,
                  1155: 28.12,
                  1156: 24.07,
                  1157: 24.48,
                  1158: 35.57,
                  1159: 29.17,
                  1160: 19.37,
                  1161: 21.03,
                  1162: 30.21,
                  1163: 22.93,
                  1164: 22.38,
                  1165: 21.9,
                  1166: 22.91,
                  1167: 26.0,
                  1168: 28.98,
                  1169: 34.61,
                  1170: 38.6,
                  1171: 17.17,
                  1251: 16.49,
                  1252: 23.35,
                  1253: 16.89,
                  1254: 37.19,
                  1255: 23.77,
                  1256: 26.7,
                  1257: 22.86,
                  1351: 20.5,
                  1352: 23.7,
                  1353: 15.38,
                  1354: 34.14,
                  1355: 20.87,
                  1356: 21.47,
                  1357: 13.91,
                  1358: 25.57,
                  1359: 17.68,
                  1360: 15.3,
                  1361: 15.25,
                  1362: 24.34,
                  1451: 16.79,
                  1452: 25.11,
                  1453: 25.56,
                  1454: 24.11,
                  1455: 43.93,
                  1456: 11.67,
                  1457: 21.95,
                  1458: 36.66,
                  1551: 23.35,
                  1552: 22.73,
                  1553: 21.75,
                  1554: 23.81,
                  1555: 18.8,
                  1556: 35.5,
                  1557: 21.3,
                  1558: 19.62,
                  1559: 21.52,
                  1560: 28.66,
                  1561: 16.58,
                  1562: 26.94,
                  1563: 18.79,
                  1564: 29.24,
                  1565: 24.9,
                  1566: 15.38,
                  1651: 17.02,
                  1652: 31.88,
                  1653: 7.72,
                  1654: 17.68,
                  1655: 21.33,
                  1656: 24.35,
                  1751: 15.71,
                  1752: 20.52,
                  1753: 19.17,
                  1754: 28.52,
                  1755: 25.33,
                  1756: 40.34,
                  1757: 32.52,
                  1758: 19.15,
                  1759: 11.54,
                  1760: 24.33,
                  1761: 15.41,
                  1762: 12.19,
                  1763: 16.56,
                  1764: 16.98,
                  2151: 19.85,
                  2152: 21.88,
                  2153: 31.53,
                  2154: 18.37,
                  2155: 32.85,
                  2156: 49.05,
                  2157: 22.43,
                  2158: 33.41,
                  2159: 26.96,
                  2251: 25.69,
                  2252: 37.51,
                  2253: 28.76,
                  2254: 11.01,
                  2255: 52.07,
                  2256: 34.43,
                  2257: 22.6,
                  2258: 53.31,
                  2259: 46.86,
                  2351: 29.53,
                  2352: 31.17,
                  2353: 35.07,
                  2354: 32.7,
                  2355: 22.35,
                  2356: 23.88,
                  2357: 11.52,
                  2358: 47.67,
                  2359: 21.44,
                  2360: 32.67,
                  2361: 45.25,
                  2451: 15.56,
                  2452: 30.75,
                  2453: 23.13,
                  2454: 20.81,
                  2455: 12.22,
                  2456: 22.21,
                  2457: 22.92,
                  2458: 23.56,
                  2459: 11.56,
                  2460: 4.88,
                  2461: 12.83,
                  3151: 22.14,
                  3152: 18.68,
                  3153: 22.88,
                  3154: 29.36,
                  3155: 16.46,
                  3156: 32.69,
                  3157: 11.35,
                  3158: 7.37,
                  3159: 22.81,
                  3160: 16.46,
                  3161: 32.87,
                  3162: 30.57,
                  3163: 56.89,
                  3164: 14.51,
                  3165: 18.17,
                  3166: 28.28,
                  3251: 16.32,
                  3252: 32.8,
                  3253: 24.22,
                  3254: 13.12,
                  3255: 24.26,
                  3256: 24.58,
                  3257: 32.96,
                  3258: 24.98,
                  3259: 14.88,
                  3260: 12.72,
                  3261: 17.24,
                  3262: 19.53,
                  3263: 39.08,
                  3351: 18.26,
                  3352: 14.79,
                  3353: 24.76,
                  3354: 33.33,
                  3355: 31.65,
                  3356: 32.24,
                  3357: 39.92,
                  3358: 16.29,
                  3359: 34.02,
                  3360: 36.98,
                  3361: 14.6,
                  3451: 16.51,
                  3452: 15.48,
                  3453: 13.99,
                  3454: 14.94,
                  3455: 15.65,
                  3456: 27.45,
                  3457: 38.94,
                  3458: 28.14,
                  3459: 20.13,
                  3460: 21.23,
                  3461: 21.06,
                  3462: 57.57,
                  3463: 17.32,
                  3464: 21.26,
                  3465: 25.37,
                  3466: 15.36,
                  4151: 18.67,
                  4152: 19.16,
                  4153: 18.19,
                  4154: 28.71,
                  4155: 18.44,
                  4156: 25.47,
                  4157: 23.31,
                  4158: 16.61,
                  4159: 10.61,
                  4160: 35.96,
                  4161: 25.78,
                  4251: 30.14,
                  4252: 5.99,
                  4253: 32.46,
                  4254: 23.25,
                  4255: 16.15,
                  4256: 42.58,
                  4257: 3.63,
                  4258: 18.62,
                  4259: 27.17,
                  4260: 35.38,
                  4261: 27.94,
                  4262: 9.25,
                  4263: 32.2,
                  4351: 27.33,
                  4352: 26.48,
                  4353: 17.93,
                  4354: 17.97,
                  4355: 13.64,
                  4356: 18.28,
                  4357: 9.74,
                  4358: 15.18,
                  4359: 8.88,
                  4360: 25.69,
                  4361: 28.89,
                  5151: 18.6,
                  5152: 10.59,
                  5153: 11.61,
                  5154: 14.42,
                  5155: 13.11,
                  5156: 19.13,
                  5157: 9.87,
                  5158: 6.36,
                  5159: 16.91,
                  5160: 16.01,
                  5251: 9.18,
                  5252: 13.2,
                  5253: 23.32,
                  5254: 3.32,
                  5255: 22.41,
                  5256: 6.97,
                  5257: 6.86,
                  5258: 13.55,
                  5259: 18.22,
                  5351: 5.09,
                  5352: 8.53,
                  5353: 20.22,
                  5355: 9.83,
                  5356: 19.31,
                  5357: 31.98,
                  6151: 46.08,
                  6152: 13.48,
                  6153: 17.53,
                  6154: 18.74,
                  6155: 17.8,
                  6156: 11.94,
                  6157: 11.5,
                  6159: 9.7,
                  6160: 20.33,
                  6161: 21.14,
                  6251: 12.63,
                  6252: 11.72,
                  6253: 6.92,
                  6254: 11.08,
                  6255: 19.21,
                  6351: 9.16,
                  6352: 13.85,
                  6353: 12.46,
                  6354: 4.64,
                  6355: 16.3,
                  6356: 10.47,
                  Total: 21.0,
                },
              },
              {
                code_variable: "voix",
                code_parti: "NIDA",
                resultat: {
                  1151: 2567,
                  1152: 884,
                  1153: 1740,
                  1154: 952,
                  1155: 1304,
                  1156: 1541,
                  1157: 765,
                  1158: 4256,
                  1159: 2275,
                  1160: 2534,
                  1161: 139,
                  1162: 1729,
                  1163: 2137,
                  1164: 1899,
                  1165: 900,
                  1166: 1909,
                  1167: 668,
                  1168: 541,
                  1169: 2540,
                  1170: 2918,
                  1171: 3262,
                  1251: 4846,
                  1252: 3291,
                  1253: 2097,
                  1254: 1875,
                  1255: 884,
                  1256: 1773,
                  1257: 1591,
                  1351: 1079,
                  1352: 1568,
                  1353: 2249,
                  1354: 2821,
                  1355: 1297,
                  1356: 1265,
                  1357: 1091,
                  1358: 2461,
                  1359: 1062,
                  1360: 1136,
                  1361: 1508,
                  1362: 2215,
                  1451: 1927,
                  1452: 1715,
                  1453: 2148,
                  1454: 1607,
                  1455: 1158,
                  1456: 766,
                  1457: 1212,
                  1458: 723,
                  1551: 3845,
                  1552: 2112,
                  1553: 2581,
                  1554: 2910,
                  1555: 1765,
                  1556: 1658,
                  1557: 2361,
                  1558: 918,
                  1559: 1654,
                  1560: 1594,
                  1561: 2188,
                  1562: 1707,
                  1563: 1384,
                  1564: 3612,
                  1565: 1376,
                  1566: 2532,
                  1651: 1230,
                  1652: 1707,
                  1653: 410,
                  1654: 1339,
                  1655: 1622,
                  1656: 678,
                  1751: 2040,
                  1752: 576,
                  1753: 607,
                  1754: 1753,
                  1755: 1162,
                  1756: 1954,
                  1757: 637,
                  1758: 1464,
                  1759: 379,
                  1760: 713,
                  1761: 627,
                  1762: 960,
                  1763: 632,
                  1764: 1557,
                  2151: 1655,
                  2152: 1182,
                  2153: 929,
                  2154: 1764,
                  2155: 989,
                  2156: 647,
                  2157: 1357,
                  2158: 432,
                  2159: 1624,
                  2251: 2139,
                  2252: 1259,
                  2253: 1636,
                  2254: 850,
                  2255: 2670,
                  2256: 1896,
                  2257: 1663,
                  2258: 1705,
                  2259: 1490,
                  2351: 1342,
                  2352: 2104,
                  2353: 1751,
                  2354: 776,
                  2355: 1210,
                  2356: 656,
                  2357: 236,
                  2358: 899,
                  2359: 549,
                  2360: 1352,
                  2361: 1678,
                  2451: 942,
                  2452: 795,
                  2453: 727,
                  2454: 609,
                  2455: 577,
                  2456: 627,
                  2457: 979,
                  2458: 962,
                  2459: 280,
                  2460: 145,
                  2461: 254,
                  3151: 1619,
                  3152: 1670,
                  3153: 2851,
                  3154: 1348,
                  3155: 1651,
                  3156: 2273,
                  3157: 937,
                  3158: 339,
                  3159: 525,
                  3160: 1757,
                  3161: 2052,
                  3162: 1143,
                  3163: 1226,
                  3164: 2057,
                  3165: 999,
                  3166: 1791,
                  3251: 3247,
                  3252: 1608,
                  3253: 1651,
                  3254: 936,
                  3255: 1161,
                  3256: 3030,
                  3257: 2774,
                  3258: 4309,
                  3259: 668,
                  3260: 971,
                  3261: 1922,
                  3262: 1786,
                  3263: 2871,
                  3351: 2785,
                  3352: 1086,
                  3353: 1166,
                  3354: 1424,
                  3355: 609,
                  3356: 3292,
                  3357: 2522,
                  3358: 1102,
                  3359: 838,
                  3360: 1283,
                  3361: 1431,
                  3451: 3517,
                  3452: 2574,
                  3453: 2960,
                  3454: 2489,
                  3455: 3636,
                  3456: 2098,
                  3457: 2899,
                  3458: 1988,
                  3459: 837,
                  3460: 1505,
                  3461: 1225,
                  3462: 1069,
                  3463: 1331,
                  3464: 1868,
                  3465: 1337,
                  3466: 539,
                  4151: 1980,
                  4152: 2116,
                  4153: 1303,
                  4154: 2734,
                  4155: 1179,
                  4156: 2063,
                  4157: 970,
                  4158: 1282,
                  4159: 649,
                  4160: 1467,
                  4161: 1978,
                  4251: 3243,
                  4252: 294,
                  4253: 1493,
                  4254: 1033,
                  4255: 2242,
                  4256: 3784,
                  4257: 119,
                  4258: 810,
                  4259: 1168,
                  4260: 808,
                  4261: 2584,
                  4262: 756,
                  4263: 1557,
                  4351: 2675,
                  4352: 1372,
                  4353: 1357,
                  4354: 783,
                  4355: 903,
                  4356: 422,
                  4357: 670,
                  4358: 759,
                  4359: 458,
                  4360: 1851,
                  4361: 3705,
                  5151: 1405,
                  5152: 245,
                  5153: 1318,
                  5154: 500,
                  5155: 995,
                  5156: 512,
                  5157: 1052,
                  5158: 60,
                  5159: 381,
                  5160: 1754,
                  5251: 626,
                  5252: 1382,
                  5253: 1037,
                  5254: 408,
                  5255: 3250,
                  5256: 888,
                  5257: 586,
                  5258: 499,
                  5259: 593,
                  5351: 263,
                  5352: 418,
                  5353: 468,
                  5355: 213,
                  5356: 146,
                  5357: 401,
                  6151: 722,
                  6152: 446,
                  6153: 1209,
                  6154: 2481,
                  6155: 1503,
                  6156: 654,
                  6157: 1118,
                  6159: 406,
                  6160: 487,
                  6161: 1661,
                  6251: 1068,
                  6252: 672,
                  6253: 155,
                  6254: 576,
                  6255: 382,
                  6351: 676,
                  6352: 609,
                  6353: 711,
                  6354: 181,
                  6355: 548,
                  6356: 666,
                  Total: 375886,
                },
              },
            ],
          },
        },
      },
    },
    2: {
      election: {
        pays: "Tunisie",
        type_election: "TNMUN",
        mode_scrutin: "Proportionnel",
        nombre_tours: 1,
        uninominal_liste: "Scrutin de listes",
        age_minimum_electeur: 18,
        age_maximum_electeur: null,
        territorial_national: false,
        partiel_general: "Générale",
        age_minimum_candidat: 23,
        age_maximum_candidat: null,
        militaires: null,
        juges: null,
        autres_exclus: null,
        parite: null,
        jeunesse: null,
        debut: "2018-05-06",
        fin: "2018-05-06",
        date_campagne: "2018-04-14",
        date_decret_officiel: "2018-05-04",
        date_loi_electorale: "2014-05-26",
        date_constitution: "2014-02-10",
        date_planifiee: "2017-12-17",
        description: "",
        silence: "2018-05-05",
        code_election: "tnmun2018",
        nom: "Elections municipales 2018",
        nombre_sieges: null,
        rcno: 8,
        decoupage_minimum: "commune",
        decoupage_maximum: "delegation",
        decoupages_consultables: null,
        version_administratif: null,
      },
      parti: {
        code_parti: "NAH",
        denomination: null,
        type: null,
        groupement: null,
        an_creation: null,
        pays: "Tunisie",
        rcno: 19,
        description: null,
        sigle: null,
        logo: null,
        classement_politique: null,
        denomination_ar:
          "\u062d\u0631\u0643\u0629 \u0627\u0644\u0646\u0647\u0636\u0629",
        denomination_fr: "Ennahdha",
      },
      resultats: {
        gouvernorat: {
          data: {
            type: "data",
            code_election: "tnmun2018",
            decoupage: "gouvernorat",
            variables: [
              {
                code_variable: "prc",
                code_parti: "NAH",
                resultat: {
                  11: 28.11,
                  12: 28.26,
                  13: 31.99,
                  14: 36.9,
                  15: 22.83,
                  16: 17.18,
                  17: 34.23,
                  21: 26.26,
                  22: 31.23,
                  23: 24.76,
                  24: 22.13,
                  31: 24.58,
                  32: 18.91,
                  33: 25.83,
                  34: 33.73,
                  41: 32.34,
                  42: 20.41,
                  43: 24.37,
                  51: 42.43,
                  52: 46.39,
                  53: 46.0,
                  61: 23.18,
                  62: 26.61,
                  63: 35.37,
                  Total: 28.64,
                },
              },
              {
                code_variable: "voix",
                code_parti: "NAH",
                resultat: {
                  11: 40234,
                  12: 22118,
                  13: 30950,
                  14: 18479,
                  15: 35196,
                  16: 6161,
                  17: 25768,
                  21: 11551,
                  22: 15446,
                  23: 10191,
                  24: 8407,
                  31: 28086,
                  32: 22931,
                  33: 18737,
                  34: 55759,
                  41: 26704,
                  42: 17136,
                  43: 19175,
                  51: 26520,
                  52: 35609,
                  53: 8296,
                  61: 14626,
                  62: 6284,
                  63: 11997,
                  Total: 516361,
                },
              },
            ],
          },
        },
        delegation: {
          data: {
            type: "data",
            code_election: "tnmun2018",
            decoupage: "delegation",
            variables: [
              {
                code_variable: "prc",
                code_parti: "NAH",
                resultat: {
                  1151: 14.23,
                  1152: 34.64,
                  1153: 23.55,
                  1154: 42.42,
                  1155: 33.3,
                  1156: 36.48,
                  1157: 36.64,
                  1158: 7.27,
                  1159: 30.32,
                  1160: 26.42,
                  1161: 58.7,
                  1162: 38.19,
                  1163: 42.17,
                  1164: 43.88,
                  1165: 39.03,
                  1166: 41.08,
                  1167: 35.03,
                  1168: 40.12,
                  1169: 22.83,
                  1170: 30.81,
                  1171: 11.75,
                  1251: 13.98,
                  1252: 28.15,
                  1253: 35.25,
                  1254: 28.48,
                  1255: 33.37,
                  1256: 54.98,
                  1257: 47.95,
                  1351: 34.35,
                  1352: 36.02,
                  1353: 31.94,
                  1354: 28.63,
                  1355: 22.16,
                  1356: 30.57,
                  1357: 18.43,
                  1358: 27.24,
                  1359: 21.08,
                  1360: 60.0,
                  1361: 35.59,
                  1362: 35.6,
                  1451: 31.72,
                  1452: 40.05,
                  1453: 38.34,
                  1454: 45.33,
                  1455: 33.04,
                  1456: 31.45,
                  1457: 38.62,
                  1458: 40.11,
                  1551: 19.94,
                  1552: 30.38,
                  1553: 31.36,
                  1554: 22.9,
                  1555: 19.61,
                  1556: 26.15,
                  1557: 16.42,
                  1558: 24.6,
                  1559: 25.37,
                  1560: 28.3,
                  1561: 19.02,
                  1562: 26.08,
                  1563: 15.06,
                  1564: 26.39,
                  1565: 19.69,
                  1566: 20.61,
                  1651: 14.78,
                  1652: 23.79,
                  1653: 14.38,
                  1654: 17.33,
                  1655: 16.9,
                  1656: 16.42,
                  1751: 32.72,
                  1752: 44.5,
                  1753: 43.35,
                  1754: 27.51,
                  1755: 12.91,
                  1756: 28.34,
                  1757: 27.46,
                  1758: 36.34,
                  1759: 32.98,
                  1760: 18.57,
                  1761: 46.31,
                  1762: 31.7,
                  1763: 63.5,
                  1764: 38.09,
                  2151: 28.63,
                  2152: 25.37,
                  2153: 21.15,
                  2154: 27.77,
                  2155: 20.86,
                  2156: 39.2,
                  2157: 24.42,
                  2158: 21.58,
                  2159: 26.61,
                  2251: 35.21,
                  2252: 33.05,
                  2253: 24.26,
                  2254: 24.76,
                  2255: 32.47,
                  2256: 43.2,
                  2257: 28.07,
                  2258: 29.39,
                  2259: 33.46,
                  2351: 17.08,
                  2352: 15.56,
                  2353: 25.1,
                  2354: 40.79,
                  2355: 30.54,
                  2356: 27.88,
                  2357: 18.01,
                  2358: 20.78,
                  2359: 23.62,
                  2360: 32.72,
                  2361: 27.08,
                  2451: 16.83,
                  2452: 36.87,
                  2453: 29.97,
                  2454: 17.73,
                  2455: 16.9,
                  2456: 21.11,
                  2457: 31.09,
                  2458: 11.43,
                  2459: 34.05,
                  2460: 13.9,
                  2461: 27.63,
                  3151: 16.76,
                  3152: 24.4,
                  3153: 18.17,
                  3154: 30.49,
                  3155: 11.35,
                  3156: 16.53,
                  3157: 22.48,
                  3158: 16.26,
                  3159: 19.03,
                  3160: 19.32,
                  3161: 32.18,
                  3162: 41.43,
                  3163: 43.11,
                  3164: 42.76,
                  3165: 25.64,
                  3166: 26.28,
                  3251: 16.37,
                  3252: 24.99,
                  3253: 27.19,
                  3254: 16.66,
                  3255: 15.42,
                  3256: 20.48,
                  3257: 33.32,
                  3258: 14.74,
                  3259: 11.38,
                  3260: 31.59,
                  3261: 11.4,
                  3262: 16.06,
                  3263: 15.45,
                  3351: 18.68,
                  3352: 25.64,
                  3353: 26.56,
                  3354: 38.41,
                  3355: 51.66,
                  3356: 33.14,
                  3357: 35.04,
                  3358: 8.74,
                  3359: 29.35,
                  3360: 51.77,
                  3361: 14.39,
                  3451: 28.12,
                  3452: 31.54,
                  3453: 36.73,
                  3454: 42.97,
                  3455: 39.01,
                  3456: 33.22,
                  3457: 29.02,
                  3458: 46.15,
                  3459: 58.14,
                  3460: 33.67,
                  3461: 26.75,
                  3462: 34.68,
                  3463: 43.82,
                  3464: 10.95,
                  3465: 12.17,
                  3466: 16.95,
                  4151: 41.3,
                  4152: 36.46,
                  4153: 30.22,
                  4154: 29.09,
                  4155: 24.84,
                  4156: 33.96,
                  4157: 35.88,
                  4158: 19.42,
                  4159: 32.79,
                  4160: 48.38,
                  4161: 26.78,
                  4251: 21.22,
                  4252: 22.81,
                  4253: 22.13,
                  4254: 34.84,
                  4255: 22.69,
                  4256: 15.24,
                  4257: 9.0,
                  4258: 3.86,
                  4259: 27.29,
                  4260: 21.28,
                  4261: 19.2,
                  4262: 21.11,
                  4263: 21.53,
                  4351: 27.24,
                  4352: 26.46,
                  4353: 28.59,
                  4354: 30.04,
                  4355: 15.41,
                  4356: 35.68,
                  4357: 12.82,
                  4358: 21.94,
                  4359: 15.16,
                  4360: 24.38,
                  4361: 32.31,
                  4362: 15.66,
                  5151: 35.62,
                  5152: 41.2,
                  5153: 37.35,
                  5154: 68.83,
                  5155: 32.56,
                  5156: 47.09,
                  5157: 49.82,
                  5158: 39.77,
                  5159: 34.18,
                  5160: 45.04,
                  5251: 49.57,
                  5252: 47.84,
                  5253: 63.43,
                  5254: 48.97,
                  5255: 39.38,
                  5256: 42.66,
                  5257: 41.33,
                  5258: 62.83,
                  5259: 42.64,
                  5351: 47.24,
                  5352: 42.06,
                  5353: 53.93,
                  5354: 29.65,
                  5355: 58.45,
                  5356: 34.79,
                  5357: 46.25,
                  6151: 28.59,
                  6152: 14.26,
                  6153: 30.92,
                  6154: 25.85,
                  6155: 18.98,
                  6156: 21.09,
                  6157: 18.79,
                  6159: 21.06,
                  6160: 40.04,
                  6161: 21.98,
                  6251: 23.27,
                  6252: 23.17,
                  6253: 53.68,
                  6254: 23.81,
                  6255: 27.55,
                  6351: 40.46,
                  6352: 38.74,
                  6353: 26.39,
                  6354: 42.37,
                  6355: 27.54,
                  6356: 31.9,
                  Total: 28.64,
                },
              },
              {
                code_variable: "voix",
                code_parti: "NAH",
                resultat: {
                  1151: 1153,
                  1152: 1249,
                  1153: 1289,
                  1154: 1687,
                  1155: 1544,
                  1156: 2336,
                  1157: 1145,
                  1158: 870,
                  1159: 2364,
                  1160: 3457,
                  1161: 388,
                  1162: 2186,
                  1163: 3931,
                  1164: 3723,
                  1165: 1604,
                  1166: 3423,
                  1167: 900,
                  1168: 749,
                  1169: 1675,
                  1170: 2329,
                  1171: 2232,
                  1251: 4109,
                  1252: 3967,
                  1253: 4377,
                  1254: 1436,
                  1255: 1241,
                  1256: 3651,
                  1257: 3337,
                  1351: 1808,
                  1352: 2383,
                  1353: 4669,
                  1354: 2365,
                  1355: 1377,
                  1356: 1801,
                  1357: 1446,
                  1358: 2622,
                  1359: 1266,
                  1360: 4455,
                  1361: 3518,
                  1362: 3240,
                  1451: 3641,
                  1452: 2736,
                  1453: 3222,
                  1454: 3021,
                  1455: 871,
                  1456: 2065,
                  1457: 2132,
                  1458: 791,
                  1551: 3283,
                  1552: 2822,
                  1553: 3721,
                  1554: 2799,
                  1555: 1841,
                  1556: 1221,
                  1557: 1820,
                  1558: 1151,
                  1559: 1950,
                  1560: 1574,
                  1561: 2510,
                  1562: 1653,
                  1563: 1109,
                  1564: 3260,
                  1565: 1088,
                  1566: 3394,
                  1651: 1068,
                  1652: 1274,
                  1653: 764,
                  1654: 1313,
                  1655: 1285,
                  1656: 457,
                  1751: 4250,
                  1752: 1249,
                  1753: 1373,
                  1754: 1691,
                  1755: 592,
                  1756: 1373,
                  1757: 538,
                  1758: 2778,
                  1759: 1083,
                  1760: 544,
                  1761: 1885,
                  1762: 2497,
                  1763: 2423,
                  1764: 3492,
                  2151: 2387,
                  2152: 1370,
                  2153: 623,
                  2154: 2667,
                  2155: 628,
                  2156: 517,
                  2157: 1477,
                  2158: 279,
                  2159: 1603,
                  2251: 2932,
                  2252: 1109,
                  2253: 1380,
                  2254: 1911,
                  2255: 1665,
                  2256: 2379,
                  2257: 2066,
                  2258: 940,
                  2259: 1064,
                  2351: 776,
                  2352: 1050,
                  2353: 1253,
                  2354: 968,
                  2355: 1654,
                  2356: 766,
                  2357: 369,
                  2358: 392,
                  2359: 605,
                  2360: 1354,
                  2361: 1004,
                  2451: 1019,
                  2452: 953,
                  2453: 942,
                  2454: 519,
                  2455: 798,
                  2456: 596,
                  2457: 1328,
                  2458: 467,
                  2459: 825,
                  2460: 413,
                  2461: 547,
                  3151: 1226,
                  3152: 2181,
                  3153: 2264,
                  3154: 1400,
                  3155: 1138,
                  3156: 1149,
                  3157: 1856,
                  3158: 748,
                  3159: 438,
                  3160: 2063,
                  3161: 2009,
                  3162: 1549,
                  3163: 929,
                  3164: 6062,
                  3165: 1410,
                  3166: 1664,
                  3251: 3257,
                  3252: 1225,
                  3253: 1853,
                  3254: 1188,
                  3255: 738,
                  3256: 2525,
                  3257: 2804,
                  3258: 2543,
                  3259: 511,
                  3260: 2412,
                  3261: 1271,
                  3262: 1469,
                  3263: 1135,
                  3351: 2849,
                  3352: 1883,
                  3353: 1251,
                  3354: 1641,
                  3355: 994,
                  3356: 3384,
                  3357: 2214,
                  3358: 591,
                  3359: 723,
                  3360: 1796,
                  3361: 1411,
                  3451: 5988,
                  3452: 5245,
                  3453: 7773,
                  3454: 7160,
                  3455: 9064,
                  3456: 2539,
                  3457: 2160,
                  3458: 3260,
                  3459: 2418,
                  3460: 2387,
                  3461: 1556,
                  3462: 644,
                  3463: 3367,
                  3464: 962,
                  3465: 641,
                  3466: 595,
                  4151: 4380,
                  4152: 4025,
                  4153: 2164,
                  4154: 2770,
                  4155: 1588,
                  4156: 2751,
                  4157: 1493,
                  4158: 1499,
                  4159: 2005,
                  4160: 1974,
                  4161: 2055,
                  4251: 2283,
                  4252: 1120,
                  4253: 1018,
                  4254: 1548,
                  4255: 3150,
                  4256: 1354,
                  4257: 295,
                  4258: 168,
                  4259: 1173,
                  4260: 486,
                  4261: 1775,
                  4262: 1725,
                  4263: 1041,
                  4351: 2667,
                  4352: 1371,
                  4353: 2164,
                  4354: 1309,
                  4355: 1020,
                  4356: 1275,
                  4357: 882,
                  4358: 1097,
                  4359: 782,
                  4360: 1757,
                  4361: 4143,
                  4362: 708,
                  5151: 2691,
                  5152: 2082,
                  5153: 4240,
                  5154: 2387,
                  5155: 2471,
                  5156: 1260,
                  5157: 5310,
                  5158: 375,
                  5159: 770,
                  5160: 4934,
                  5251: 3380,
                  5252: 5010,
                  5253: 2820,
                  5254: 6019,
                  5255: 5711,
                  5256: 5436,
                  5257: 3531,
                  5258: 2314,
                  5259: 1388,
                  5351: 2439,
                  5352: 2062,
                  5353: 1248,
                  5354: 438,
                  5355: 1266,
                  5356: 263,
                  5357: 580,
                  6151: 448,
                  6152: 472,
                  6153: 2133,
                  6154: 3422,
                  6155: 1602,
                  6156: 1155,
                  6157: 1827,
                  6159: 881,
                  6160: 959,
                  6161: 1727,
                  6251: 1967,
                  6252: 1329,
                  6253: 1202,
                  6254: 1238,
                  6255: 548,
                  6351: 2986,
                  6352: 1704,
                  6353: 1506,
                  6354: 2847,
                  6355: 926,
                  6356: 2028,
                  Total: 516361,
                },
              },
            ],
          },
        },
      },
    },
  };

  function findMinMaxValues(normalizedMap) {
    const result = {};

    for (const key in normalizedMap) {
      result[key] = {
        delegation: {
          min: Infinity,
          max: -Infinity,
        },
        gouvernorat: {
          min: Infinity,
          max: -Infinity,
        },
      };

      const data = normalizedMap[key].normalizedData;

      for (const level in data) {
        for (const prcKey in data[level].prc) {
          const value = data[level].prc[prcKey];
          if (value < result[key][level].min) {
            result[key][level].min = value;
          }
          if (value > result[key][level].max) {
            result[key][level].max = value;
          }
        }
      }
    }
    result[3] = {
      delegation: {
        min: Math.min(result[1].delegation.min, result[2].delegation.min),
        max: Math.max(result[1].delegation.max, result[2].delegation.max),
      },
      gouvernorat: {
        min: Math.min(result[1].gouvernorat.min, result[2].gouvernorat.min),
        max: Math.max(result[1].gouvernorat.max, result[2].gouvernorat.max),
      },
    };

    return result;
  }

  const normalizeData = (obj) => {
    const normalizedData = {};

    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {
        normalizedData[key] = {};

        const variables = obj[key].data.variables;
        variables.forEach((item) => {
          const { code_variable, resultat } = item;
          normalizedData[key][code_variable] = {};

          for (const code in resultat) {
            if (resultat.hasOwnProperty(code)) {
              normalizedData[key][code_variable][code] = resultat[code];
            }
          }
        });
      }
    }

    return normalizedData;
  };

  const calculateClasses = (data) => {
    const classNumber = {};

    for (const key in data) {
      classNumber[key] = {};

      for (const level in data[key]) {
        const min = data[key][level].min;
        const max = data[key][level].max;

        const dataRange = max - min;
        const minClasses = Math.max(5, Math.ceil(dataRange / 12));

        classNumber[key][level] = minClasses;
      }
    }

    return classNumber;
  };

  useEffect(() => {
    let normalizedMap = {};
    for (const key in map) {
      const data = normalizeData(map[key].resultats);

      normalizedMap[key] = { ...map[key], normalizedData: data };
    }
    const minMax = findMinMaxValues(normalizedMap);
    const classNumber = calculateClasses(minMax);

    dispatch(setMinMax(minMax));
    dispatch(setClassNumber(classNumber));
    dispatch(setMaps(normalizedMap));
  }, [dispatch]);

  const [toggleLayer, setToggleLayer] = useState(false);

  const [geojson, setGeojson] = useState({});

  //MAP FILES FETCHING, RESTORE THIS WHEN SERVER WORKS AGAIN

  // useEffect(() => {
  //   const fetchAndUseGeoJSON = async (level) => {
  //     try {
  //       const map = await getGeoJSON(level);
  //       return { [level]: map };
  //     } catch (error) {
  //       console.error("Error:", error);
  //       throw error;
  //     }
  //   };

  //   Promise.all(levels.map(fetchAndUseGeoJSON))
  //     .then((results) => {
  //       const formattedResults = {};
  //       results.forEach((entry) => {
  //         const key = Object.keys(entry)[0];
  //         formattedResults[key] = entry[key];
  //       });
  //       setGeojson(formattedResults);
  //     })
  //     .catch((error) => {
  //       console.error("An error occurred:", error);
  //     });
  // }, []);

  useEffect(() => {
    const formattedResults = {
      gouvernorat: gouvernorat,
      delegation: delegation,
    };
    setGeojson(formattedResults);
  }, []);

  useEffect(() => {
    const calculateBounds = async () => {
      const boundsObject = {};

      for (const mapName in geojson) {
        if (geojson.hasOwnProperty(mapName)) {
          boundsObject[mapName] = {};

          const geoJSON = geojson[mapName];

          geoJSON.features.forEach((feature) => {
            const code = feature.properties[`code_${mapName}`];

            const geometryType = feature.geometry.type;
            let bounds;

            const polygons =
              geometryType === "Polygon"
                ? [feature.geometry.coordinates]
                : feature.geometry.coordinates;

            const latLngs = [];
            for (const polygon of polygons) {
              for (const ring of polygon) {
                latLngs.push(
                  ...ring.map((coord) => L.latLng(coord[1], coord[0]))
                );
              }
            }

            bounds = L.latLngBounds(latLngs);

            boundsObject[mapName][code] = {
              name: feature.properties[`nom_${mapName}`],
              bounds,
            };
          });
        }

        if (Object.keys(boundsObject).length === levels.length) {
          setBounds(boundsObject);
        }
      }
    };
    if (geojson) calculateBounds();
  }, [geojson]);

  // useEffect(() => {
  //   dispatch(initializeElections());
  // }, [dispatch]);

  // if (init)
  return (
    <MaterialCssVarsProvider theme={{ [MATERIAL_THEME_ID]: materialTheme }}>
      <CssVarsProvider theme={theme}>
        <CssBaseline />
        <Layout.Root>
          <Layout.Header>
            <Navbar />
          </Layout.Header>
          <Layout.TopPanel>
            <MapTitle
              electionInfo={map[1]["election"]}
              parti={map[1]["parti"]}
            />
            {compare && (
              <MapTitle
                electionInfo={map[2]["election"]}
                parti={map[2]["parti"]}
              />
            )}
          </Layout.TopPanel>
          <Layout.Main>
            <Sheet
              className="map container"
              sx={{
                display: "flex",
                flexDirection: "row",
                justifyContent: "center",
              }}
            >
              <MapCard
                // map={map[1]}
                // electionInfo={map[1]["election"]}
                toggleLayer={toggleLayer}
                geojson={geojson}
                bounds={bounds}
                ID={1}
              />
              {compare && (
                <>
                  <Divider orientation="vertical" />
                  <MapCard
                    // map={map[2]}
                    // electionInfo={map[2]["election"]}
                    toggleLayer={toggleLayer}
                    geojson={geojson}
                    bounds={bounds}
                    ID={2}
                  />
                </>
              )}
            </Sheet>
          </Layout.Main>
        </Layout.Root>
      </CssVarsProvider>
    </MaterialCssVarsProvider>
  );
}

export default App;
